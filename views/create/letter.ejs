<%- include('../partials/header', { title: 'Vintage Love Letter ğŸ’Œ - Be My Valentine' }) %>

    <div class="create-page letter-theme">
        <header class="create-header">
            <a href="/" class="back-link">â† Back</a>
            <h1>ğŸ’Œ Vintage Love Letter</h1>
            <p>Write a timeless letter sealed with love</p>
        </header>

        <div class="love-meter">
            <div class="love-meter-top">
                <span class="eyebrow">Love Meter</span>
                <span class="love-meter-label" id="loveMeterLabel">Warming up...</span>
            </div>
            <div class="love-meter-bar">
                <div class="love-meter-fill" id="loveMeterFill"></div>
            </div>
        </div>

        <form id="letterForm" class="create-form">
            <input type="hidden" name="persona" value="letter">

            <div class="form-row">
                <div class="form-group">
                    <label for="sender_name">From</label>
                    <input type="text" id="sender_name" name="sender_name" required placeholder="Your name">
                </div>
                <div class="form-group">
                    <label for="recipient_name">To</label>
                    <input type="text" id="recipient_name" name="recipient_name" required placeholder="Their name">
                </div>
            </div>

            <div class="form-group">
                <label for="letter">Your Letter</label>
                <textarea id="letter" name="letter" required rows="10" placeholder="My dearest...

Write from your heart. Tell them what they mean to you, share memories, express your feelings...

I cannot imagine my days without your smile, your warmth, your gentle spirit..."></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Wax Seal Color</label>
                    <div class="seal-options">
                        <label class="seal-option">
                            <input type="radio" name="sealColor" value="red" checked>
                            <span class="seal-preview red">â¤ï¸</span>
                            <span>Classic Red</span>
                        </label>
                        <label class="seal-option">
                            <input type="radio" name="sealColor" value="gold">
                            <span class="seal-preview gold">ğŸ’›</span>
                            <span>Royal Gold</span>
                        </label>
                        <label class="seal-option">
                            <input type="radio" name="sealColor" value="navy">
                            <span class="seal-preview navy">ğŸ’™</span>
                            <span>Navy Blue</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="signature">Closing & Signature</label>
                <input type="text" id="signature" name="signature" required placeholder="Forever yours, [Your name]">
            </div>

            <!-- Gift Section -->
            <%- include('../partials/gift-reveal') %>

            <%- include('../partials/premium') %>

                <button type="submit" class="btn btn-primary btn-large">Seal My Letter ğŸ’Œ</button>
        </form>
    </div>

    <script>
        function initLoveMeter(formId) {
            const fill = document.getElementById('loveMeterFill');
            const label = document.getElementById('loveMeterLabel');
            const form = document.getElementById(formId);
            if (!form || !fill || !label) return;
            const update = () => {
                const fields = Array.from(form.querySelectorAll('input[type="text"], textarea, input[type="datetime-local"]'))
                    .filter(el => !el.disabled && el.type !== 'hidden');
                const total = fields.length || 1;
                const filled = fields.filter(el => (el.value || '').trim().length > 0).length;
                const percent = Math.min(100, Math.round((filled / total) * 100));
                fill.style.width = percent + '%';
                label.textContent = percent >= 90 ? 'Overflowing with love' : percent >= 60 ? 'Heartwarming' : 'Warming up...';
            };
            form.addEventListener('input', update);
            update();
        }

        initLoveMeter('letterForm');

        document.getElementById('letterForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData(this);

            const letter = formData.get('letter').trim();
            if (letter.length < 50) {
                alert('Pour your heart out! Write at least a few sentences.');
                return;
            }

            const premium = window.getPremiumData ? window.getPremiumData() : null;
            const premiumContent = premium && premium.audioNote ? { audioNote: premium.audioNote } : null;

            const data = {
                persona: 'letter',
                sender_name: formData.get('sender_name'),
                recipient_name: formData.get('recipient_name'),
                content: JSON.stringify({
                    letter: letter,
                    sealColor: formData.get('sealColor'),
                    signature: formData.get('signature'),
                    gift: getGiftData(),
                    premium: premiumContent
                }),
                reveal_at: premium?.revealAt || null,
                passphrase: premium?.passphrase || ''
            };

            try {
                const res = await fetch('/api/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await res.json();
                if (result.success) {
                    // Save to local history
                    const historyItem = {
                        unique_id: result.unique_id,
                        recipient_name: formData.get('recipient_name'),
                        sender_name: formData.get('sender_name'),
                        persona: 'letter',
                        created_at: new Date().toISOString(),
                        status: 'pending'
                    };
                    const currentHistory = JSON.parse(localStorage.getItem('my_valentines') || '[]');
                    currentHistory.push(historyItem);
                    localStorage.setItem('my_valentines', JSON.stringify(currentHistory));

                    window.location.href = result.statusUrl;
                } else {
                    alert(result.error || 'Something went wrong');
                }
            } catch (err) {
                alert('Failed to create. Please try again.');
            }
        });
    </script>

    <%- include('../partials/footer') %>
