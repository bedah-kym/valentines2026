<%- include('../partials/header', { title: 'Achievement Unlocked üèÜ - Be My Valentine' }) %>

    <div class="create-page achievement-theme">
        <header class="create-header">
            <a href="/" class="back-link">‚Üê Back</a>
            <h1>üèÜ Achievement Unlocked</h1>
            <p>Create epic relationship achievements</p>
        </header>

        <div class="info-card">
            <strong>How their game works</strong>
            <ul>
                <li>They click anywhere to reveal achievements; each gives +100 XP.</li>
                <li>After all unlocks, the Legendary screen shows your proposal.</li>
                <li>If they accept, gift/date surprise + audio note reveal next.</li>
                <li>Time capsule / passphrase (if set) blocks the page until unlocked.</li>
            </ul>
        </div>

        <div class="love-meter">
            <div class="love-meter-top">
                <span class="eyebrow">Love Meter</span>
                <span class="love-meter-label" id="loveMeterLabel">Warming up...</span>
            </div>
            <div class="love-meter-bar">
                <div class="love-meter-fill" id="loveMeterFill"></div>
            </div>
        </div>

        <form id="achievementForm" class="create-form">
            <input type="hidden" name="persona" value="achievement">

            <div class="form-group">
                <label for="sender_name">Your Gamertag (Name)</label>
                <input type="text" id="sender_name" name="sender_name" required placeholder="Player 1">
            </div>

            <div class="form-group">
                <label for="recipient_name">Their Gamertag (Name)</label>
                <input type="text" id="recipient_name" name="recipient_name" required placeholder="Player 2">
            </div>

            <div class="achievements-section">
                <h3>üéÆ Relationship Achievements</h3>
                <p class="helper-text">Create 5-10 achievements. Mix fun and heartfelt!</p>

                <div id="achievementsContainer">
                    <div class="achievement-input">
                        <span class="achievement-tier bronze">ü•â</span>
                        <div class="achievement-fields">
                            <input type="text" name="titles[]" required placeholder="First Date Hero">
                            <input type="text" name="descriptions[]" required
                                placeholder="Survived the awkward silence">
                            <select name="tiers[]">
                                <option value="bronze">Bronze</option>
                                <option value="silver">Silver</option>
                                <option value="gold">Gold</option>
                                <option value="platinum">Platinum</option>
                            </select>
                        </div>
                    </div>
                    <!-- (abbreviated initial achievement inputs for brevity in this replace block, keeping it functional) -->
                    <div class="achievement-input">
                        <span class="achievement-tier silver">ü•à</span>
                        <div class="achievement-fields">
                            <input type="text" name="titles[]" required placeholder="Laugh Master">
                            <input type="text" name="descriptions[]" required
                                placeholder="Made them snort-laugh 50 times">
                            <select name="tiers[]">
                                <option value="bronze">Bronze</option>
                                <option value="silver" selected>Silver</option>
                                <option value="gold">Gold</option>
                                <option value="platinum">Platinum</option>
                            </select>
                        </div>
                    </div>
                    <div class="achievement-input">
                        <span class="achievement-tier gold">ü•á</span>
                        <div class="achievement-fields">
                            <input type="text" name="titles[]" required placeholder="Memory Keeper">
                            <input type="text" name="descriptions[]" required
                                placeholder="Remembered all the important dates">
                            <select name="tiers[]">
                                <option value="bronze">Bronze</option>
                                <option value="silver">Silver</option>
                                <option value="gold" selected>Gold</option>
                                <option value="platinum">Platinum</option>
                            </select>
                        </div>
                    </div>
                </div>

                <button type="button" id="addAchievement" class="btn btn-secondary">+ Add Achievement</button>
            </div>

            <!-- Gift Section -->
            <%- include('../partials/gift-reveal') %>

            <%- include('../partials/premium') %>

                <div class="form-group proposal-section">
                    <label for="finalProposal">üèÜ LEGENDARY Achievement (Your Proposal)</label>
                    <input type="text" id="finalProposal" name="finalProposal" required
                        placeholder="Will you be my Valentine?" value="Will you be my Valentine?">
                </div>

                <button type="submit" class="btn btn-primary btn-large">Unlock These Achievements üéÆ</button>
        </form>
    </div>

    <script>
        let achievementCount = 3; // Started with 3 examples
        const maxAchievements = 10;

        function initLoveMeter(formId) {
            const fill = document.getElementById('loveMeterFill');
            const label = document.getElementById('loveMeterLabel');
            const form = document.getElementById(formId);
            if (!form || !fill || !label) return;
            const update = () => {
                const fields = Array.from(form.querySelectorAll('input[type="text"], textarea, input[type="datetime-local"]'))
                    .filter(el => !el.disabled && el.type !== 'hidden');
                const total = fields.length || 1;
                const filled = fields.filter(el => (el.value || '').trim().length > 0).length;
                const percent = Math.min(100, Math.round((filled / total) * 100));
                fill.style.width = percent + '%';
                label.textContent = percent >= 90 ? 'Overflowing with love' : percent >= 60 ? 'Heartwarming' : 'Warming up...';
            };
            form.addEventListener('input', update);
            update();
        }

        initLoveMeter('achievementForm');

        // Update tier icon when dropdown changes
        document.addEventListener('change', function (e) {
            if (e.target.name === 'tiers[]') {
                const icons = { bronze: 'ü•â', silver: 'ü•à', gold: 'ü•á', platinum: 'üíé' };
                const tierSpan = e.target.closest('.achievement-input').querySelector('.achievement-tier');
                tierSpan.textContent = icons[e.target.value];
                tierSpan.className = 'achievement-tier ' + e.target.value;
            }
        });

        document.getElementById('addAchievement').addEventListener('click', function () {
            if (achievementCount >= maxAchievements) {
                alert('Maximum 10 achievements allowed!');
                return;
            }
            achievementCount++;
            const container = document.getElementById('achievementsContainer');
            const div = document.createElement('div');
            div.className = 'achievement-input';
            div.innerHTML = `
      <span class="achievement-tier bronze">ü•â</span>
      <div class="achievement-fields">
        <input type="text" name="titles[]" placeholder="Achievement title...">
        <input type="text" name="descriptions[]" placeholder="Description...">
        <select name="tiers[]">
          <option value="bronze">Bronze</option>
          <option value="silver">Silver</option>
          <option value="gold">Gold</option>
          <option value="platinum">Platinum</option>
        </select>
      </div>
      <button type="button" class="remove-btn" onclick="this.parentElement.remove(); achievementCount--;">√ó</button>
    `;
            container.appendChild(div);
        });

        document.getElementById('achievementForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const titles = formData.getAll('titles[]');
            const descriptions = formData.getAll('descriptions[]');
            const tiers = formData.getAll('tiers[]');

            const achievements = titles.map((title, i) => ({
                title: title,
                desc: descriptions[i],
                tier: tiers[i]
            })).filter(a => a.title.trim() && a.desc.trim());

            if (achievements.length < 3) {
                alert('Please create at least 3 achievements!');
                return;
            }

            const premium = window.getPremiumData ? window.getPremiumData() : null;
            const premiumContent = premium && premium.audioNote ? { audioNote: premium.audioNote } : null;

            const data = {
                persona: 'achievement',
                sender_name: formData.get('sender_name'),
                recipient_name: formData.get('recipient_name'),
                content: JSON.stringify({
                    achievements: achievements,
                    finalProposal: formData.get('finalProposal'),
                    gift: getGiftData(),
                    premium: premiumContent
                }),
                reveal_at: premium?.revealAt || null,
                passphrase: premium?.passphrase || ''
            };

            try {
                const res = await fetch('/api/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await res.json();
                if (result.success) {
                    // Save to local history
                    const historyItem = {
                        unique_id: result.unique_id,
                        recipient_name: formData.get('recipient_name'),
                        sender_name: formData.get('sender_name'),
                        persona: 'achievement',
                        created_at: new Date().toISOString(),
                        status: 'pending'
                    };
                    const currentHistory = JSON.parse(localStorage.getItem('my_valentines') || '[]');
                    currentHistory.push(historyItem);
                    localStorage.setItem('my_valentines', JSON.stringify(currentHistory));

                    window.location.href = result.statusUrl;
                }
                else {
                    alert(result.error || 'Something went wrong');
                }
            } catch (err) {
                alert('Failed to create. Please try again.');
            }
        });
    </script>

    <%- include('../partials/footer') %>
