<%- include('../partials/header', { title: 'Achievement Unlocked üèÜ - Be My Valentine' }) %>

    <div class="create-page achievement-theme">
        <header class="create-header">
            <a href="/" class="back-link">‚Üê Back</a>
            <h1>üèÜ Achievement Unlocked</h1>
            <p>Create epic relationship achievements</p>
        </header>

        <form id="achievementForm" class="create-form">
            <input type="hidden" name="persona" value="achievement">

            <div class="form-group">
                <label for="sender_name">Your Gamertag (Name)</label>
                <input type="text" id="sender_name" name="sender_name" required placeholder="Player 1">
            </div>

            <div class="form-group">
                <label for="recipient_name">Their Gamertag (Name)</label>
                <input type="text" id="recipient_name" name="recipient_name" required placeholder="Player 2">
            </div>

            <div class="achievements-section">
                <h3>üéÆ Relationship Achievements</h3>
                <p class="helper-text">Create 5-10 achievements. Mix fun and heartfelt!</p>

                <div id="achievementsContainer">
                    <div class="achievement-input">
                        <span class="achievement-tier bronze">ü•â</span>
                        <div class="achievement-fields">
                            <input type="text" name="titles[]" required placeholder="First Date Hero">
                            <input type="text" name="descriptions[]" required
                                placeholder="Survived the awkward silence">
                            <select name="tiers[]">
                                <option value="bronze">Bronze</option>
                                <option value="silver">Silver</option>
                                <option value="gold">Gold</option>
                                <option value="platinum">Platinum</option>
                            </select>
                        </div>
                    </div>
                    <!-- (abbreviated initial achievement inputs for brevity in this replace block, keeping it functional) -->
                    <div class="achievement-input">
                        <span class="achievement-tier silver">ü•à</span>
                        <div class="achievement-fields">
                            <input type="text" name="titles[]" required placeholder="Laugh Master">
                            <input type="text" name="descriptions[]" required
                                placeholder="Made them snort-laugh 50 times">
                            <select name="tiers[]">
                                <option value="bronze">Bronze</option>
                                <option value="silver" selected>Silver</option>
                                <option value="gold">Gold</option>
                                <option value="platinum">Platinum</option>
                            </select>
                        </div>
                    </div>
                    <div class="achievement-input">
                        <span class="achievement-tier gold">ü•á</span>
                        <div class="achievement-fields">
                            <input type="text" name="titles[]" required placeholder="Memory Keeper">
                            <input type="text" name="descriptions[]" required
                                placeholder="Remembered all the important dates">
                            <select name="tiers[]">
                                <option value="bronze">Bronze</option>
                                <option value="silver">Silver</option>
                                <option value="gold" selected>Gold</option>
                                <option value="platinum">Platinum</option>
                            </select>
                        </div>
                    </div>
                </div>

                <button type="button" id="addAchievement" class="btn btn-secondary">+ Add Achievement</button>
            </div>

            <!-- Gift Section -->
            <%- include('../partials/gift-reveal') %>

                <div class="form-group proposal-section">
                    <label for="finalProposal">üèÜ LEGENDARY Achievement (Your Proposal)</label>
                    <input type="text" id="finalProposal" name="finalProposal" required
                        placeholder="Will you be my Valentine?" value="Will you be my Valentine?">
                </div>

                <button type="submit" class="btn btn-primary btn-large">Unlock These Achievements üéÆ</button>
        </form>
    </div>

    <script>
        let achievementCount = 3; // Started with 3 examples
        const maxAchievements = 10;

        // Update tier icon when dropdown changes
        document.addEventListener('change', function (e) {
            if (e.target.name === 'tiers[]') {
                const icons = { bronze: 'ü•â', silver: 'ü•à', gold: 'ü•á', platinum: 'üíé' };
                const tierSpan = e.target.closest('.achievement-input').querySelector('.achievement-tier');
                tierSpan.textContent = icons[e.target.value];
                tierSpan.className = 'achievement-tier ' + e.target.value;
            }
        });

        document.getElementById('addAchievement').addEventListener('click', function () {
            if (achievementCount >= maxAchievements) {
                alert('Maximum 10 achievements allowed!');
                return;
            }
            achievementCount++;
            const container = document.getElementById('achievementsContainer');
            const div = document.createElement('div');
            div.className = 'achievement-input';
            div.innerHTML = `
      <span class="achievement-tier bronze">ü•â</span>
      <div class="achievement-fields">
        <input type="text" name="titles[]" placeholder="Achievement title...">
        <input type="text" name="descriptions[]" placeholder="Description...">
        <select name="tiers[]">
          <option value="bronze">Bronze</option>
          <option value="silver">Silver</option>
          <option value="gold">Gold</option>
          <option value="platinum">Platinum</option>
        </select>
      </div>
      <button type="button" class="remove-btn" onclick="this.parentElement.remove(); achievementCount--;">√ó</button>
    `;
            container.appendChild(div);
        });

        document.getElementById('achievementForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const titles = formData.getAll('titles[]');
            const descriptions = formData.getAll('descriptions[]');
            const tiers = formData.getAll('tiers[]');

            const achievements = titles.map((title, i) => ({
                title: title,
                desc: descriptions[i],
                tier: tiers[i]
            })).filter(a => a.title.trim() && a.desc.trim());

            if (achievements.length < 3) {
                alert('Please create at least 3 achievements!');
                return;
            }

            const data = {
                persona: 'achievement',
                sender_name: formData.get('sender_name'),
                recipient_name: formData.get('recipient_name'),
                content: JSON.stringify({
                    achievements: achievements,
                    finalProposal: formData.get('finalProposal'),
                    gift: getGiftData()
                })
            };

            try {
                const res = await fetch('/api/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await res.json();
                if (result.success) {
                    window.location.href = result.statusUrl;
                } else {
                    alert(result.error || 'Something went wrong');
                }
            } catch (err) {
                alert('Failed to create. Please try again.');
            }
        });
    </script>

    <%- include('../partials/footer') %>