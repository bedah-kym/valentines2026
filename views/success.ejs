<%- include('layout', { body: ` <div class="success-page">
    <div class="success-content">
        <div class="success-icon">${proposal.status === 'accepted' ? 'ðŸ’•' : proposal.status === 'rejected' ? 'ðŸ’”' :
            'ðŸ’Œ'}</div>
        <h1>${proposal.status === 'accepted' ? 'They said YES!' : proposal.status === 'rejected' ? 'Maybe next time...'
            : 'Waiting for a response...'}</h1>

        <div class="proposal-details">
            <p><strong>To:</strong> ${proposal.recipient_name}</p>
            <p><strong>From:</strong> ${proposal.sender_name}</p>
            <p><strong>Status:</strong> <span class="status status-${proposal.status}">${proposal.status}</span></p>
        </div>

        <div class="share-section">
            <p>Share this link with your Valentine:</p>
            <div class="share-link">
                <input type="text"
                    value="${typeof window !== 'undefined' ? window.location.origin : ''}/v/${proposal.unique_id}"
                    readonly id="shareUrl">
                <button onclick="copyLink()" class="btn btn-secondary">Copy</button>
            </div>
        </div>

        <div class="premium-pay" id="premiumPay">
            <h3>Premium Unlock (Optional)</h3>
            <p class="helper-text">All premium features together: time capsule, passphrase lock, audio note, gift surprise, keepsake card.</p>
            ${paymentStatus === 'paid'
                ? '<div class="status status-accepted">Premium unlocked</div>'
                : paymentLink
                    ? `<a href="${paymentLink}" class="btn btn-primary" target="_blank" rel="noopener">Unlock premium for KES 50 total</a>`
                    : '<p class="helper-text">Payment link not configured.</p>'}
            <p class="helper-text" id="paymentStatusText"></p>
        </div>

        ${paymentStatus === 'paid'
            ? `<a href="/v/${proposal.unique_id}/keepsake" class="btn btn-secondary" target="_blank" rel="noopener">Download Keepsake Card</a>`
            : '<div class="helper-text">Keepsake unlocks after payment.</div>'}

        <a href="/" class="btn btn-primary">Create Another</a>
    </div>
    </div>

    <script>
        // Fix the URL on client side
        document.getElementById('shareUrl').value = window.location.origin + '/v/${proposal.unique_id}';

        function copyLink() {
            const input = document.getElementById('shareUrl');
            input.select();
            document.execCommand('copy');
            event.target.textContent = 'Copied!';
            setTimeout(() => event.target.textContent = 'Copy', 2000);
        }

        const paymentStatusText = document.getElementById('paymentStatusText');
        const params = new URLSearchParams(window.location.search);
        if (params.get('paid') === '1' && paymentStatusText) {
            paymentStatusText.textContent = 'Confirming payment...';
            let attempts = 0;
            const maxAttempts = 8;
            const timer = setInterval(async () => {
                attempts += 1;
                try {
                    const res = await fetch('/api/payment-status/${proposal.unique_id}');
                    const data = await res.json();
                    if (data.payment_status === 'paid') {
                        clearInterval(timer);
                        window.location.href = '/success/${proposal.unique_id}';
                        return;
                    }
                } catch (e) {
                    // ignore
                }
                if (attempts >= maxAttempts) {
                    clearInterval(timer);
                    paymentStatusText.textContent = 'Payment pending. We will unlock once confirmed.';
                }
            }, 3000);
        }
    </script>
    ` }) %>
