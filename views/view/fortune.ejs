<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweet Notes for <%= proposal.recipient_name %></title>
    <meta property="og:title" content="A tray of sweet notes awaits">
    <meta property="og:description" content="Open each love note, then open the letter in the middle.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Inter:wght@400;500;600&family=Playfair+Display:wght@400;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>

<body class="view-page fortune-view">
    <%- include('../partials/lock', { lockInfo, proposalId: proposal.unique_id }) %>
    <div class="fortune-scene">
        <div class="table-cloth"></div>

        <div class="start-overlay" id="fortuneStart">
            <div class="start-card">
                <div class="start-title">A tray of sweet notes</div>
                <p class="start-copy">Think of them like tiny treats with little love notes inside. Open them all, then open the love letter in the middle.</p>
                <div class="start-actions">
                    <button class="btn btn-primary" id="startFortune">Start opening</button>
                    <span class="start-hint"><%= content.messages.length %> notes, one big letter.</span>
                </div>
            </div>
        </div>

        <header class="view-header">
            <p class="from-text">A sweet note for <strong>
                    <%= proposal.recipient_name %>
                </strong></p>
            <p class="instruction">Open each note around the center letter. When all are open, the letter unlocks.</p>
            <div class="progress-hud fortune-progress" id="fortuneProgress"></div>
        </header>

        <%- include('../partials/audio-note') %>

        <% const splitIndex = Math.ceil(content.messages.length / 2); %>
        <% const topNotes = content.messages.slice(0, splitIndex); %>
        <% const bottomNotes = content.messages.slice(splitIndex); %>

        <div class="fortune-board" id="fortuneBoard">
            <div class="note-row">
                <% topNotes.forEach((msg, i)=> { %>
                    <button type="button" class="note-token" data-index="<%= i %>">
                        <span class="note-chip">Open</span>
                        <span class="note-tag">Sweet note <%= i + 1 %></span>
                    </button>
                <% }) %>
            </div>

            <button type="button" class="letter-center locked" id="finalLetter" data-index="final">
                <div class="letter-crest">&#10084;</div>
                <div class="letter-title">Love Letter</div>
                <div class="letter-sub" id="letterHint">Unlock after all notes</div>
            </button>

            <div class="note-row">
                <% bottomNotes.forEach((msg, i)=> { %>
                    <% const noteIndex = i + splitIndex; %>
                    <button type="button" class="note-token" data-index="<%= noteIndex %>">
                        <span class="note-chip">Open</span>
                        <span class="note-tag">Sweet note <%= noteIndex + 1 %></span>
                    </button>
                <% }) %>
            </div>
        </div>

        <div class="fortune-display hidden" id="fortuneDisplay">
            <div class="fortune-card">
                <p class="fortune-text" id="fortuneText"></p>
                <button class="btn btn-secondary" onclick="closeFortune()">Next note</button>
            </div>
        </div>

        <div class="proposal-overlay hidden" id="proposalOverlay">
            <div class="confetti-container" id="confetti"></div>
            <div class="proposal-card">
                <p class="from-label">From <%= proposal.sender_name %>
                </p>
                <h1 class="proposal-text">
                    <%= content.finalProposal %>
                </h1>
                <div class="note-input-section">
                    <textarea id="responseNote" class="note-textarea"
                        placeholder="Send a little note back... (optional)"></textarea>
                </div>
                <div class="response-buttons">
                    <button class="btn btn-accept" onclick="respond('accepted')">Yes!</button>
                    <button class="btn btn-reject" onclick="respond('rejected')">Not this time</button>
                </div>
            </div>
        </div>
        <div class="acceptance-overlay hidden" id="acceptanceOverlay">
            <div class="stroke-text">I choose you</div>
            <div class="burst-hearts" id="burstHearts"></div>
        </div>
    </div>

    <%- include('../partials/gift-display') %>

    <script>
        const messages = <%- JSON.stringify(content.messages) %>;
        const totalNotes = messages.length;
        let openedCount = 0;
        let started = false;
        const proposalId = '<%= proposal.unique_id %>';
        const progressEl = document.getElementById('fortuneProgress');
        const startOverlay = document.getElementById('fortuneStart');
        const finalLetter = document.getElementById('finalLetter');
        const letterHint = document.getElementById('letterHint');

        function updateProgress() {
            if (!progressEl) return;
            if (openedCount >= totalNotes) {
                progressEl.textContent = 'All notes opened. The love letter is ready.';
                return;
            }
            progressEl.textContent = `${openedCount} of ${totalNotes} notes opened`;
        }

        function highlightNextNote() {
            document.querySelectorAll('.note-token').forEach(note => note.classList.remove('note-hint'));
            const nextNote = document.querySelector('.note-token:not(.opened)');
            if (nextNote) {
                nextNote.classList.add('note-hint');
            }
        }

        function startFortune() {
            if (started) return;
            started = true;
            startOverlay?.classList.add('hidden');
            console.log('[fortune] started', { totalNotes });
            updateProgress();
            highlightNextNote();
        }

        document.getElementById('startFortune')?.addEventListener('click', startFortune);
        startOverlay?.addEventListener('click', (event) => {
            if (event.target && event.target.id === 'fortuneStart') {
                startFortune();
            }
        });
        const fortuneBoard = document.getElementById('fortuneBoard');
        const noteButtons = Array.from(document.querySelectorAll('.note-token'));
        console.log('[fortune] notes found', noteButtons.length, 'board?', !!fortuneBoard);

        // Event delegation (belt + suspenders)
        fortuneBoard?.addEventListener('click', (event) => {
            const target = event.target.closest('.note-token, .letter-center');
            if (!target) return;
            event.preventDefault();
            console.log('[fortune] board click', { index: target.dataset.index });
            openNote(target);
        });

        // Direct listeners in case delegation is blocked by layout
        noteButtons.forEach((button) => {
            button.addEventListener('click', (event) => {
                event.preventDefault();
                openNote(button);
            });
        });
        finalLetter?.addEventListener('click', (event) => {
            event.preventDefault();
            openNote(finalLetter);
        });

        function openNote(el) {
            console.log('[fortune] click', { index: el?.dataset?.index });
            if (!started) {
                startFortune();
            }
            if (el.dataset.index === 'final') {
                if (openedCount < totalNotes) {
                    console.log('[fortune] final locked', { openedCount, totalNotes });
                    if (letterHint) {
                        const previous = letterHint.textContent;
                        letterHint.textContent = 'Open all notes first.';
                        setTimeout(() => {
                            letterHint.textContent = previous;
                        }, 2000);
                    }
                    return;
                }
                console.log('[fortune] final opened');
                document.getElementById('proposalOverlay').classList.remove('hidden');
                createConfetti();
                return;
            }

            if (el.classList.contains('opened')) return;

            const idx = Number(el.dataset.index);
            if (!Number.isInteger(idx) || idx < 0 || idx >= messages.length) {
                console.log('[fortune] invalid index', { idx, length: messages.length });
                return;
            }
            console.log('[fortune] opening', { idx, message: messages[idx] });
            el.classList.add('opened');
            el.disabled = true;

            const message = messages[idx] || '';
            openedCount++;
            showFortune(message);

            if (openedCount === totalNotes) {
                finalLetter?.classList.remove('locked');
            }

            updateProgress();
            highlightNextNote();
        }

        function showFortune(message) {
            document.getElementById('fortuneText').textContent = message;
            document.getElementById('fortuneDisplay').classList.remove('hidden');
        }

        function closeFortune() {
            document.getElementById('fortuneDisplay').classList.add('hidden');
            highlightNextNote();
        }

        function createConfetti() {
            const container = document.getElementById('confetti');
            if (!container) return;
            container.innerHTML = '';
            const colors = ['#ff6b6b', '#ffd93d', '#6bcb77', '#4d96ff', '#ff6bd6'];
            for (let i = 0; i < 20; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti-piece';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 2 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                container.appendChild(confetti);
            }
            setTimeout(() => {
                container.innerHTML = '';
            }, 6000);
        }

        function showAcceptanceOverlay() {
            const overlay = document.getElementById('acceptanceOverlay');
            const burst = document.getElementById('burstHearts');
            if (!overlay || !burst) return;
            burst.innerHTML = '';
            for (let i = 0; i < 20; i++) {
                const heart = document.createElement('div');
                heart.className = 'burst-heart';
                heart.innerHTML = '&#10084;';
                heart.style.left = Math.random() * 100 + '%';
                heart.style.animationDelay = Math.random() * 0.5 + 's';
                burst.appendChild(heart);
            }
            overlay.classList.remove('hidden');
            setTimeout(() => overlay.classList.add('hidden'), 2200);
        }

        async function respond(status) {
            const note = document.getElementById('responseNote').value;
            try {
                const res = await fetch('/api/respond/' + proposalId, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status, note })
                });
                if (!res.ok) {
                    throw new Error('Response failed');
                }
            } catch (err) {
                alert('Failed to send response');
                return;
            }

            try {
                const overlay = document.getElementById('proposalOverlay');
                overlay.innerHTML = '<div class="response-confirmation">' +
                    (status === 'accepted'
                        ? '<h1>&#10084;</h1><p>Your response has been sent!</p>'
                        : '<h1>&#128148;</h1><p>Maybe next time...</p>') +
                    '</div>';

                if (status === 'accepted') {
                    showAcceptanceOverlay();
                    setTimeout(() => {
                        if (typeof showGiftReveal === 'function') {
                            showGiftReveal();
                        }
                    }, 3000);
                }
            } catch (err) {
                console.error('UI update error:', err);
            }
        }
    </script>

</body>

</html>
